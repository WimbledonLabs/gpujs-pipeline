<html>
    <head>

<style>
body {

}

#debug {
    font-family: monospace;
    color: #f0f0f0;
    background-color: #333333;
    word-break: break-all;
    padding: 0.2em;
}
</style>
    </head>
    <body>
    <div id="debug"></div>

    <canvas id="scaled" width="512" height="512">
    </canvas>

    <script src="js/gpu.js?nocache"></script>
    <script>
function print(s) {
    document.getElementById("debug").innerHTML += s + "<br />";
}

// sleep taken from http://stackoverflow.com/questions/951021/what-is-the-javascript-version-of-sleep
function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
}

var mode = "gpu";

var gpu = new GPU();
var opt = {
        dimensions: [100]
};

var myFunc = gpu.createKernel(function(x) {
    return this.dimensions.z;
}).mode(mode).dimensions([100]);

print(myFunc(42));
print("test");

var render = gpu.createKernel(function() {
    var sx = (this.thread.x - 10) / 8;
    var sy = (this.thread.y - 10) / 8;
    var c = Math.sqrt(sx*sx + sy*sy);
    this.color(c, c, c, 1);
}).mode(mode).dimensions([20, 20]).width(512).height(512).graphical(true);


var ident = gpu.createKernel(function(grid) {
    var x = this.thread.x;
    var y = this.thread.y;

    var sum = grid[0][y-1][x-1] + grid[0][y-1][x+0] + grid[0][y-1][x+1] +
              grid[0][y-0][x-1] +         0         + grid[0][y-0][x+1] +
              grid[0][y+1][x-1] + grid[0][y+1][x+0] + grid[0][y+1][x+1];

    var c;

    if (grid[0][x][y] == 0 && sum == 3) {
        c = 1;
    } else if (grid[0][x][y] > 0 && sum > 1.9 && sum < 3.1) {
        c = 1;
    } else {
        c = 0;
    }

    //var c = g[this.thread.y][this.thread.x];
    this.color(c, c, c, 1);
}).mode(mode).dimensions([9, 9]).width(512).height(512).graphical(true);

var canvas = render.getCanvas();
document.getElementsByTagName('body')[0].appendChild(canvas);

var scaledNode = document.getElementById("scaled");
var scaled = scaledNode.getContext('2d');
scaled.imageSmoothingEnabled = false;
scaled.mozImageSmoothingEnabled = false;
scaled.webkitImageSmoothingEnabled = false;
scaled.msImageSmoothingEnabled = false;

var r = [
[0, 0, 0, 0, 0, 0, 0, 0, 0],
[0, 0, 0, 0, 0, 0, 0, 0, 0],
[0, 0, 0, 0, 0, 0, 0, 0, 0],
[0, 0, 0, 0, 1, 0, 0, 0, 0],
[0, 0, 0, 0, 1, 0, 0, 0, 0],
[0, 0, 0, 0, 1, 0, 0, 0, 0],
[0, 0, 0, 0, 0, 0, 0, 0, 0],
[0, 0, 0, 0, 0, 0, 0, 0, 0],
[0, 0, 0, 0, 0, 0, 0, 0, 0]
]

var g = r
var b = g

var a = [
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1],
[1, 1, 1, 1, 1, 1, 1, 1, 1]
]

var grid = [r, g, b, a];

if (mode !== "cpu") {
    scaledNode.style.display = "none";
}

async function test() {
    while (1) {
        var t = 0;
        //render(Math.random(), Math.random(), Math.random());
        //render();
        ident(grid);
        await sleep(t);
        if (mode === "cpu") {
            scaled.drawImage(canvas, 0, 0, 20, 20,
                                     0, 0, 512, 512);
        }
        await sleep(700 - t);
    }
}

test()

//window.alert("test")
    </script>
    </body>
</html>
